@{
    ViewData["Title"] = "Система безпеки дому";
}

<div class="container py-4">
    <h1 class="mb-5 text-center fw-bold text-primary">
        <i class="bi bi-shield-lock-fill me-2"></i>Система безпеки дому
    </h1>

    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <button id="alarmToggle" class="btn btn-lg shadow-sm" 
                    style="border: 2px solid #0d6efd; transition: all 0.3s ease;">
                <i class="bi bi-shield-check fs-1"></i>
                <span class="d-block mt-2 fs-5">
                    Система активного захисту: 
                    <span id="alarmStatusText">...</span>
                </span>
            </button>
        </div>
    </div>

    <ul class="nav nav-tabs" id="sensorTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-sensors-tab" data-bs-toggle="tab" data-bs-target="#all-sensors" type="button" role="tab" aria-controls="all-sensors" aria-selected="true">
                Всі датчики
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="glass-sensors-tab" data-bs-toggle="tab" data-bs-target="#glass-sensors" type="button" role="tab" aria-controls="glass-sensors" aria-selected="false">
                Датчики розбиття скла
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="door-sensors-tab" data-bs-toggle="tab" data-bs-target="#door-sensors" type="button" role="tab" aria-controls="door-sensors" aria-selected="false">
                Датчики відкриття дверей
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="motion-sensors-tab" data-bs-toggle="tab" data-bs-target="#motion-sensors" type="button" role="tab" aria-controls="motion-sensors" aria-selected="false">
                Датчики руху
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="video-sensors-tab" data-bs-toggle="tab" data-bs-target="#video-sensors" type="button" role="tab" aria-controls="video-sensors" aria-selected="false">
                Відеодзвінок
            </button>
        </li>
    </ul>

    <div class="row my-3">
        <div class="col-md-4 offset-md-8">
            <label for="locationFilter" class="form-label fw-bold text-primary">Фільтр за локацією:</label>
            <select id="locationFilter" class="form-select">
                <option value="">Всі локації</option>
                <option value="Головний вхід">Головний вхід</option>
                <option value="Вітальня">Вітальня</option>
                <option value="Тамбур">Тамбур</option>
                <option value="Задній вхід">Задній вхід</option>
                <option value="Підсобне приміщення">Підсобне приміщення</option>
                <option value="Житлова кімната 1">Житлова кімната 1</option>
                <option value="Житлова кімната 2">Житлова кімната 2</option>
                <option value="Коридор">Коридор</option>
            </select>
        </div>
    </div>

    <div class="tab-content mt-4" id="sensorTabsContent">
        <div class="tab-pane fade show active" id="all-sensors" role="tabpanel" aria-labelledby="all-sensors-tab">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-primary text-white text-center">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i> Датчики розбиття скла
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table id="glassBreakTableAll" class="table table-striped table-hover align-middle mb-0 text-center">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Назва</th>
                                            <th>Локація</th>
                                            <th>Параметр</th>
                                            <th>Значення</th>
                                            <th>Сигнал тривоги</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-primary text-white text-center">
                            <i class="bi bi-door-open-fill me-1"></i> Датчики відкриття дверей
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table id="doorTableAll" class="table table-striped table-hover align-middle mb-0 text-center">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Назва</th>
                                            <th>Локація</th>
                                            <th>Параметр</th>
                                            <th>Значення</th>
                                            <th>Сигнал тривоги</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-primary text-white text-center">
                            <i class="bi bi-person-walking me-1"></i> Датчики руху
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table id="motionTableAll" class="table table-striped table-hover align-middle mb-0 text-center">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Назва</th>
                                            <th>Локація</th>
                                            <th>Параметр</th>
                                            <th>Значення</th>
                                            <th>Сигнал тривоги</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-primary text-white text-center">
                            <i class="bi bi-camera-video-fill me-1"></i> Відеодзвінок
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table id="videoDoorbellTableAll" class="table table-striped table-hover align-middle mb-0 text-center">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Назва</th>
                                            <th>Локація</th>
                                            <th>Параметр</th>
                                            <th>Значення</th>
                                            <th>Сигнал тривоги</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="glass-sensors" role="tabpanel" aria-labelledby="glass-sensors-tab">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> Датчики розбиття скла
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="glassBreakTable" class="table table-striped table-hover align-middle mb-0 text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Назва</th>
                                    <th>Локація</th>
                                    <th>Параметр</th>
                                    <th>Значення</th>
                                    <th>Сигнал тривоги</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="door-sensors" role="tabpanel" aria-labelledby="door-sensors-tab">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <i class="bi bi-door-open-fill me-1"></i> Датчики відкриття дверей
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="doorTable" class="table table-striped table-hover align-middle mb-0 text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Назва</th>
                                    <th>Локація</th>
                                    <th>Параметр</th>
                                    <th>Значення</th>
                                    <th>Сигнал тривоги</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="motion-sensors" role="tabpanel" aria-labelledby="motion-sensors-tab">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <i class="bi bi-person-walking me-1"></i> Датчики руху
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="motionTable" class="table table-striped table-hover align-middle mb-0 text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Назва</th>
                                    <th>Локація</th>
                                    <th>Параметр</th>
                                    <th>Значення</th>
                                    <th>Сигнал тривоги</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="video-sensors" role="tabpanel" aria-labelledby="video-sensors-tab">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <i class="bi bi-camera-video-fill me-1"></i> Відеодзвінок
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="videoDoorbellTable" class="table table-striped table-hover align-middle mb-0 text-center">
                            <thead class="table-light">
                                <tr>
                                    <th>Назва</th>
                                    <th>Локація</th>
                                    <th>Параметр</th>
                                    <th>Значення</th>
                                    <th>Сигнал тривоги</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function updateAlarmStatus() {
            try {
                const response = await fetch('/Security/GetAlarmStatus');
                if (!response.ok) throw new Error('Помилка мережі');
                const data = await response.json();

                const btn = document.getElementById('alarmToggle');
                const statusText = document.getElementById('alarmStatusText');

                btn.classList.toggle('active', data.isActive);
                statusText.textContent = data.isActive ? 'АКТИВОВАНО' : 'ВИМКНЕНО';
                btn.style.backgroundColor = data.isActive ? '#0d6efd' : '';
                btn.style.color = data.isActive ? 'white' : '';

            } catch (error) {
                console.error('Помилка оновлення статусу:', error);
            }
        }

        document.getElementById('alarmToggle').addEventListener('click', async () => {
            try {
                const response = await fetch('/Security/ToggleAlarm', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                if (!response.ok) throw new Error('Помилка перемикання');
                await updateAlarmStatus();

            } catch (error) {
                console.error('Помилка:', error);
                alert('Сталася помилка! Спробуйте ще раз.');
            }
        });

        function buildTableRows(sensors) {
            return sensors.map(s => {
                const badge = s.isAlert
                    ? '<span class="badge bg-danger">Тривога</span>'
                    : '<span class="badge bg-success">Норма</span>';
                return `
                    <tr>
                        <td class="col-name">${s.name}</td>
                        <td class="col-location">${s.locationName}</td>
                        <td class="col-label">${s.dataLabel}</td>
                        <td class="col-value">${s.data}</td>
                        <td class="col-alert text-center">${badge}</td>
                    </tr>`;
            }).join('');
        }

        function updateSensors() {
            fetch('/Security/GetSensors')
                .then(response => {
                    if (!response.ok) throw new Error('Помилка мережі');
                    return response.json();
                })
                .then(data => {
                    const selectedLocation = document.querySelector('#locationFilter').value;
                    if (selectedLocation) {
                        data = data.filter(x => x.locationName === selectedLocation);
                    }

                    const glassBreakRows = buildTableRows(data.filter(x => x.sensorType === 0));
                    const doorRows = buildTableRows(data.filter(x => x.sensorType === 1));
                    const motionRows = buildTableRows(data.filter(x => x.sensorType === 2));
                    const videoRows = buildTableRows(data.filter(x => x.sensorType === 3));

                    const updateTable = (selector, rows) => {
                        const tbody = document.querySelector(selector);
                        if (tbody) tbody.innerHTML = rows;
                    };

                    updateTable('#glassBreakTableAll tbody', glassBreakRows);
                    updateTable('#doorTableAll tbody', doorRows);
                    updateTable('#motionTableAll tbody', motionRows);
                    updateTable('#videoDoorbellTableAll tbody', videoRows);

                    updateTable('#glassBreakTable tbody', glassBreakRows);
                    updateTable('#doorTable tbody', doorRows);
                    updateTable('#motionTable tbody', motionRows);
                    updateTable('#videoDoorbellTable tbody', videoRows);
                })
                .catch(err => console.error('Помилка оновлення датчиків:', err));
        }

        document.addEventListener("DOMContentLoaded", () => {
            updateAlarmStatus();
            updateSensors();
            setInterval(updateSensors, 7000);
            document.querySelector('#locationFilter').addEventListener('change', updateSensors);
        });
</script>
}